\documentclass[12pt,letterpaper]{article}
\usepackage{natbib}

%Packages
\usepackage{pdflscape}
\usepackage{fixltx2e}
\usepackage{textcomp}
\usepackage{fullpage}
\usepackage{float}
\usepackage{latexsym}
\usepackage{url}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{bm}
\usepackage{array}
\usepackage[version=3]{mhchem}
\usepackage{ifthen}
\usepackage{caption}
\usepackage{hyperref}
\usepackage{amsthm}
\usepackage{amstext}
\usepackage{enumerate}
\usepackage[osf]{mathpazo}
\usepackage{dcolumn}
\usepackage{lineno}
\usepackage{dcolumn}
\usepackage{mathtools}
\usepackage{pdflscape}

\DeclarePairedDelimiter\abs{\lvert}{\rvert}%
\DeclarePairedDelimiter\norm{\lVert}{\rVert}%
\newcolumntype{d}[1]{D{.}{.}{#1}}

\pagenumbering{arabic}


%Pagination style and stuff
\linespread{2}
\raggedright
\setlength{\parindent}{0.5in}
\setcounter{secnumdepth}{0} 
\renewcommand{\section}[1]{%
\bigskip
\begin{center}
\begin{Large}
\normalfont\scshape #1
\medskip
\end{Large}
\end{center}}
\renewcommand{\subsection}[1]{%
\bigskip
\begin{center}
\begin{large}
\normalfont\itshape #1
\end{large}
\end{center}}
\renewcommand{\subsubsection}[1]{%
\vspace{2ex}
\noindent
\textit{#1.}---}
\renewcommand{\tableofcontents}{}
%\bibpunct{(}{)}{;}{a}{}{,}

%---------------------------------------------
%
%       START
%
%---------------------------------------------

\begin{document}

%Running head
\begin{flushright}
Version dated: \today
\end{flushright}
\bigskip
\noindent RH: Characters correlation

\bigskip
\medskip
\begin{center}

\noindent{\Large \bf Influence of different modes of morphological character correlation on tree inference}
\bigskip

\noindent {\normalsize \sc Thomas Guillerme$^1$$^2$$^*$, and Martin D. Brazeau$^2$$^3$}\\
\noindent {\small \it 
$^1$School of Biological Sciences, University of Queensland, St. Lucia, Queensland, Australia.\\
$^2$Imperial College London, Silwood Park Campus, Department of Life Sciences, Buckhurst Road, Ascot SL5 7PY, United Kingdom.\\
$^3$Department of Earth Sciences, Natural History Museum, Cromwell Road, London, SW75BD, United Kingdom.\\}

\end{center}
\medskip
\noindent{*\bf Corresponding author.} \textit{guillert@tcd.ie}\\ 
\vspace{1in}

%Line numbering
\modulolinenumbers[1]
\linenumbers

%---------------------------------------------
%
%       ABSTRACT
%
%---------------------------------------------

% SystBiol
% Palaeobiology
% JEB
% Biological Journal of the Linnean Society
% Royal Society Open Science - but rewriting needed (more story style)
% Palaeontology


\newpage
\begin{abstract}
Morphological characters for building phylogenies are assumed to be independent.
However, this assumption is nearly always wrong simply because of the nature of morphological integration of organisms.
Correlation between characters can originate from biological features, shared phylogenetic history or errors when coding or defining morphological characters.
Although the two first sources can be investigated by biologists \textit{a posteriori} and the third one can be avoided \textit{a priori} with good practices, phylogenetic software do not distinguish between any of them.

In this study, we propose a new metric of raw character difference as a proxy for character correlation.
Using thorough simulations, we test the effect of increasing or decreasing character differences on tree topology.
Overall, we found an expected positive effect of reducing character correlations on recovering the correct topology.
However, this effect is less important for matrices with a small number of taxa (~25) were reducing character correlation is not more effective than randomly drawing characters.
Furthermore, in bigger matrices (~350 taxa), there is a strong effect of the inference method with Bayesian trees being consistently less affected by character correlation than maximum parsimony trees.

These results suggest that ignoring the problem of character correlation or independence can often impact topology in phylogenetic analysis.
However, encouragingly, they also suggest that, unless correlation is actively maximised or minimised, probabilistic methods can easily accommodate for a random correlation between characters.

\end{abstract}

\noindent (Keywords: Character difference, correlation, topology, Bayesian, Maximum Parsimony)\\

\vspace{1.5in}

\newpage 

%---------------------------------------------
%
%       INTRODUCTION
%
%---------------------------------------------
\section{Introduction}

The last two decades have witnessed a resurgence of interest in the use of morphological character data in phylogenetic studies.
This owes in large part to the use of fossils to untertake at least partial reconstructions of phylogenetic trees, especially where ancestral states reconstructions or absolute calibrations of divergence times are necessary. 
Morphological character data are often considered inferior to molecular sequence data, but are often the only source of data---especially for fossils.
While there is a general appreciation of the limits of morphological data, they are frequently dismissed without any empirical investigations into their statistical properties.
As morphological data are likely to continue to play an extensive role in phylogenetic analysis, it is essential to understand the circumstances under which morphological data might be expected to 'misbehave'.
This opens up possibilities for predicting problematic datasets and possibly proposing new confidence measures in phylogenetic datasets.
%The last decade has witnessed a resurgence of use of discrete morphological data in macroevolutionary studies.
%Traditionally confined to ``classic'' cladistic studies in palaeontology, these methods have recently been widely expanded and improved whether based on the models and methods for inferring phylogenies \citep[e.g.][]{heath2014fossilized,Wright01072016} or to combine them with molecular data \citep[e.g.][]{pyrondivergence2011,ronquista2012}.
%In parallel, much development has also been done on the pre-phylogenetic analysis \citep[e.g. data collection;][]{morphobank} as well as on post-phylogenetic ones \citep[e.g. morphological disparity analysis;][]{Close2015,Claddis}.
%Nonetheless, using discrete morphological data in macroevolutionary studies comes with several caveats based to the nature of data used \citep{Guillerme2016146,bapst2017combined}; the coding of this data \citep{Brazeau2011,simoes2017giant}; the topology inference method \citep{spencerefficacy2013,wrightbayesian2014,OReilly20160081,puttick2017uncertain,goloboff2017weighted} or the dating methods \citep{Arcila2015131,o2016tips}.

%One such caveat, however, is often neglected: the correlation between morphological characters.
The non-independence of large numbers of morphological characters is often cited in anticipation of problems with morphological data.
The assumption of character independence is central to phylogenetic inference methods such as maximum likelihood and maximum parsimony. \citep[e.g.][]{joysey1982problems,felsenstein1985phylogenies,lewisa2001,felsenstein2004inferring}.
%Nowadays, this assumption of character independence is nearly always accepted as a fact and rarely tested or even questioned in empirical datasets.
Especially for discrete morphological data, this assumption of independence is probably violated frequently due to the sheer nature of phylogenetic data: correlations are expected to occur (to some degree) when characters are depending on each other.
% TG: add Brazeau et al. 201X somewhere?
Before discussing character correlation further, it is important to understand that it may manifest itself in at least three distinct ways:

\begin{itemize}

    \item \textbf{Biological dependence:} this is the result of an intrinsic biological link between two characters through development, pleiotropy, and/or biological function.
    %If it's a trivial example, then why use it? That said, it's unclear that this example would be genetic/developmental, and not fall under the second category. We should actually reconsider this example and how we express the difference between this and the next type of correlation.
    %One trivial 
    For example the lower and upper molar characters in mammals generally occlude one another. 
    Therefore, one character describing a feature of a lower molar will be expected to be complemented by the surface of the occluding upper molar.
    This will therefore provide a source of characters that would be expected to directly co-vary.
     %They're not readily studied. They're actually quite difficult to study.
    These links are usually the targets of comparative developmental biology \citep{goswami2006morphological,goswami2010,goswami2014macroevolutionary}.

    \item \textbf{Evolutionary dependence:} this is the result of sets of characters co-evolving: the character's correlation is thus due to their shared evolutionary history.
% MDB: Does the above really describe this correctly. This actually sounds a lot more like genuine synapomorphy than potentially problematic correlation. 

    Many methods have been developed to study these correlations, especially since they can provide us with a lot of information on how specific groups acquired specific characteristics \citep{Lande1983,Maddison1990,Pagel1994,Pagel2006,Grabowski2016}.
    For example, the apparition of the jaw as a character in gnatosthomes correlates with a whole suite of characters present in modern gnatosthomes (e.g. beaks, tribosphenic molars, jaw protrusion, etc.). %TG: this links to inapplicable data!
%MDB: The above is really coding dependence that you describe below, in a way. It's a character hierarchy. What we would like to discuss here is probably something more like limb reduction and axial elongation, for instance. These two things seem to co-vary extensively in tetrapods, with snake-like body forms evolving multiple times in numerous tetrapod lineages.

    \item \textbf{Coding dependence:} this is the results of researchers methodology for defining or/and coding discrete morphological characters \citep{Brazeau2011,simoes2017giant}.
    One such source of correlation could be due to methodological errors: for example by defining a character describing a particular feature on a left and right molar.
    It is worth noting, however, that these correlations could also be due to the nature of the available data, especially in palaeontology.
    For example, when only one fragmentary molar is available to describe a specimen, researchers have to ``extract'' as much phylogenetic information from the available data as possible, potentially inducing correlations.
\end{itemize}

\noindent Of course, the three sources of dependences can also be correlated to each other: characters describing the left and right lower/upper molars will have induced dependence due to the modularity of the molars, their shared history and the duplicated coding!
The three types sources are however dissociated by the later (coding dependence) being detected prior to phylogenetic inference and the two other ones (biological and evolutionary) being only detected and/or tested \textit{a posteriori} based on a phylogenetic hypothesis.

These sources of dependence between characters are well studied in biology.
Biological and evolutionary dependences are inherent parts to evo-devo and maroevolution and best practices to avoid coding induced dependences are commonly known and applied.
However, eventually, all these characters, whether they are independent or not are analysed through phylogenetic inferences software that are blind to these distinctions.
This introduces a new, less studied, source of character dependence:

\noindent \textbf{Correlation between characters detected by the software}: this is the result how software actually interprets the differences between characters.
The vast majority of phylogenetic software ignores both the character's definition and the different states signification (simply treating them as different/similar tokens).
Therefore a great number of characters and - traditionally - a few number of tokens can easily lead to dependence between characters.
For example, if we consider the following matrix containing four cetartiodactyles - say a pig (e.g. \textit{Sus}), a deer (\textit{Cervus}), a hippo (\textit{Hippopotamus}) and a whale (\textit{Balaenoptera}) - and four binary characters - say (\textbf{C1}: presence (1) or absence (0) of an astragal; \textbf{C2}: presence (0) or absence (1) of baleens; \textbf{C3}: presence (0) or absence (1) of a left astragal with a double pulley; \textbf{C4}: presence (0) or absence (1) of a right astragal with a double pulley:

\begin{table}
\center
    \begin{tabular}{r|cccc}
            & C1 & C2 & C3 & C4\\
        \hline
        \textit{Sus} & 1 & 1 & 1 & 1\\
        \textit{Cervus} & 1 & 1 & 1 & 1\\
        \textit{Hippopotamus} & 1 & 1 & 1 & 1\\
        \textit{Balaenoptera} & 0 & 0 & 0 & 0\\
    \end{tabular}
    \caption{Example of a matrix with software induced character correlation. \textbf{C1}: presence (1) or absence (0) of an astragal; \textbf{C2}: presence (0) or absence (1) of baleens; \textbf{C3}: presence (0) or absence (1) of a left astragal with a double pulley; \textbf{C4}: presence (0) or absence (1) of a right astragal with a double pulley.}
    \label{Tab:example_matrix}
\end{table}

In the example in Table \ref{Tab:example_matrix}, the characters \textbf{C1} and \textbf{C2} are the most likely to be truly independent; characters \textbf{C3} and \textbf{C4} suffer from a a coding induced dependency; characters \textbf{C1} and \textbf{C3}/\textbf{C4} have an evolutionary induce dependency and again, characters \textbf{C2} and \textbf{C3}/\textbf{C4} are likely to be independent.
Yet a phylogenetic software will treat all these four characters in exactly the same way: only the sheer difference between the different character states tokens will be used in order to infer a phylogenetic tree.
It is thus still unclear what will be the effect of characters correlation on phylogenetic inference: how does these correlation really affect topology?

If the three sources of correlation are fairly well studied, their actual interpretation by phylogenetic inference software, has, to our knowledge, never been studied through a simulation protocol (although they have been explored empirically for morphological data; \citealt{Davalos01072014}; or molecular data; \citealt{ZouConvergence}).
In this study, we formally assess the effect of discrete character's correlation using simulated data.
We propose a new metric to measure the difference between characters (as a proxy for these three sources of correlation as interpreted by the software) and a protocol to modify discrete morphological matrices to increase/decrease the overall differences/similarities between characters.
We found that overall, there is a detectable effect of character correlation on topology where an increase in character dependence results in a decrease in the ability to recover the correct topology.
These results, however, vary in magnitude depending on the size of matrix and the inference method used.

\section{Methods}

We applied the following simulation protocol to assess the effect of characters correlation (Fig.\ref{Fig:outline}):
\begin{enumerate}
    \item \textbf{Simulating matrices}: we simulated a discrete morphological matrices with 25, 75 and 150 taxa for 100, 350 and 1000 characters, hereafter called the ``normal'' matrices. This step resulted in 9 matrices.
    \item \textbf{Modifying matrices}: we modified the ``normal'' matrices by modified the characters in order to maximise or minimise characters differences (hereafter called respectively ``maximised'' and ``minimised'' matrices) by removing respectively the least or most different characters and replacing them randomly by the remaining characters.
    We also randomly duplicated characters from the ``normal'' matrices without biasing towards maximising or minimising character differences to create randomised matrices (hereafter called the ``randomised'' matrices - equivalent to a null expectancy). This step resulted in 36 matrices.
    \item \textbf{Inferring topologies}: we inferred the topologies from the ``normal'', ``maximised'', ``minimised'' and ``randomised'' matrices using both Maximum Parsimony and Bayesian inference (hereafter called the ``normal'', ``maximised'', ``minimised'' and ``randomised'' trees). This step resulted in 72 topologies.
    \item \textbf{Comparing topologies}: finally, we compared the ``normal'' to the ``maximised'', ``minimised'' and ``randomised'' trees to measure the effect of character correlation on topology.
\end{enumerate}
Each step was replicated 40 times and are described below in more details, along with our proposed definition for measuring the difference between characters.

\begin{figure}[!htbp]
\centering
   \includegraphics[width=0.9\textwidth]{Figures/outline.pdf}
\caption{Outline of the simulation protocol: the first step includes both the simulation and the modification of the matrices (thin solid lines); the second step includes tree inference using Maximum Parsimony and Bayesian inference (thick solid lines); the third step includes comparing the resulting tree topologies (dashed lines). $n$ and $m$ corresponds to the number of characters with a character difference $<0.25$ and $>0.75$ respectively.}
\label{Fig:outline}
\end{figure}

\subsection{Measuring differences between characters}
\label{CD_description}
To measure the effect of character correlation as interpreted by the phylogenetic software, we define characters as being entirely correlated if they give the same phylogenetic information.
In order to measure this, we propose a new distance metric to measure the difference between two characters:

\subsubsection{Characters Difference ($CD$)}
\begin{equation}
    CD_{(x,y)} = 1 - \left(\frac{\abs*{\frac{\sum_{i}^{n}\abs{x_{i} - y_{i}}}{n}-\frac{1}{2}}}{\frac{1}{2}}\right)
\end{equation}

\noindent Where $n$ is the number of taxa with comparable data and $x_i$ and $y_i$ are each characters states for the characters $x$ and $y$ and the taxa $i$.
$CD$ is a continuous distance metric bounded between $0$ and $1$ (see the mathematical demonstration in the Supplementary Material 1).
Since we are considering differences as being only Fitch-like (i.e. non-weighted and non-ordinate), we calculated the difference between character states in a qualitative way.
Two same character states tokens have a difference of zero and two different ones have a difference of one (e.g. $0 - 0 = 0$ or $1 - 8 = 1$).
Additionally, we only consider differences for taxa with shared information \citep[i.e. a Gower distance;][]{GowerDist}.
We standardised each character by arbitrarily modifying their character state tokens by order of appearance.
In other words, we replaced all the occurrences of the first token to be $1$, the second to be $2$, etc.
This way, a character \texttt{A = \{2,2,3,0,0,3\}} would be standardised as \texttt{A' = \{1,1,2,3,3,2\}} \citep[following the \textit{xyz} notation in][p.13]{felsenstein2004inferring}.
Note that in terms of phylogenetic signal, both \texttt{A} and \texttt{A'} are exactly identical (forming three distinct groups).

When the character difference null ($0$) it means that characters convey the same phylogenetic signal (i.e. characters are entirely correlated).
When the character difference maximal ($1$) it means it conveys the most different signal (i.e. characters are uncorrelated).
It is important to stress that a character difference of $0$ (i.e. the same phylogenetic signal) does not mean the opposite of $1$ (i.e. \textit{not} the opposite phylogenetic signal) .
For example with three characters \texttt{A = \{0,1,1,1\}}, \texttt{B = \{1,0,0,0\}} and \texttt{C = \{0,1,2,3\}}, $CD_{(A,B)} = 0$ and $CD_{(A,C)} = 1$.
Because the character is continuous and bounded between $(0,1)$, it can be interpreted as the probability of two characters leading to a different phylogenetic interpretation.

\subsection{Simulating discrete morphological matrices}
To simulate the matrices we applied a protocol very similar to \cite{Guillerme2016146}.
First, we generate random birth-death trees with the birth ($\lambda$) and death ($\mu$) parameters sampled from a uniform $(0,1)$ distribution maintaining $\lambda$ $>$ $\mu$ using the \texttt{diversitree} \texttt{R} package \citep[v0.9-8;][]{fitzjohndiversitree2012} and saving the tree after reaching either 25, 75 or 150 taxa.
For each tree, we arbitrarily set the outgroup to be the first taxa (alphabetically) thus effectively rooting the trees on this taxa.
These trees are hereafter called the ``true'' trees.
We then simulated discrete morphological characters on the topology of these trees using the either of the two following models:
\begin{itemize}
    \item The morphological HKY-binary model \citep{OReilly20160081} which is an HKY model \citep{HKY85} with a random states frequency (sampled from a uniform distribution $(0,1)$ and scaled to sum to $1$) and using a transition/transvertion rate of $2$ \citep{douadycomparison2003} but where the purines (A,G) were changed into state $0$ and the pyrimidines (C,T) in state $1$.
    This model has the advantage of not favouring Bayesian inference \citep[since it doesn't use a M$k$ model;][; see discussion]{OReilly20160081} but the downside of it is it can only generate binary state characters \citep[or 4 states;][]{puttick2017uncertain}.
    \item To generate more than binary states characters, we used the M$k$ model \citep{lewisa2001}.
    We draw the number of character states with a probability of $0.85$ for binary characters and $0.15$ for three state characters \citep{Guillerme2016146,ZouConvergence}.
    This model assumes a equal transition rate between character states that might seem overly simplifying and excludes other observed transition patterns \citep[e.g. Dollo characters;][]{Dollo,wright2015came}.
    Recently however, \cite{Wright01072016} have shown that an equal rate transition is still the most present in empirical data.
\end{itemize}

\noindent For each character, both models (morphological HKY-binary or M$k$) where chosen randomly and ran with an overall evolutionary rate drawn from a gamma distribution ($\beta$ = $100$ and $\alpha$ = $5$).
This low evolutionary rate values allowed to reduce the number of homoplasic character changes and thus reinforce the phylogenetic information in the matrices.
We re-simulated every invariant characters to obtain a matrix with no invariant characters.
To ensure that our simulation where reflecting realistic observed parameters, we only selected matrices with Consistency Indices (CI) superior to $0.26$ \citep{OReilly20160081}.

For each trees with 25, 75 or 150 taxa we generated matrices with 100, 350 and 1000 characters following \cite{OReilly20160081}.
The matrices where generated using the \texttt{dispRity R} package \citep{thomas_guillerme_2016_55646}.
To estimate the variance of our simulations and assess the effect of our random parameters, we repeated this step 40 times resulting in 360 ``normal'' morphological matrices.

\subsection{Modifying the matrices}
We calculated the pairwise character differences for each generated matrices using the \texttt{dispRity R} package \citep{thomas_guillerme_2016_55646}.
We then modified the matrices to either maximise or minimise the pairwise character differences for each matrices using three different algorithms.
For maximising the pairwise differences between characters, we selected the characters that where the most similar to all the others (i.e. with an average character difference $<0.25$) and replaced them randomly by any of the remaining characters.
This operation increased the overall pairwise character difference in the matrix thus making the characters more dissimilar.
Conversely, for minimising the pairwise character differences, we selected the most dissimilar characters (i.e. with an average character difference $<0.75$) and randomly replaced them with the remaining ones.
Finally, because this operation effectively changes the weight of characters (i.e. giving the characters $<0.25$ or $>0.75$ a weight of $0$ and giving the randomly selected remaining characters a weight of +$1$), we randomly replaced the average number of characters replaced in the character maximisation and minimisation by any other characters as a randomised expectation modification (i.e. randomly weighting characters).
Each of the three matrices are effectively a bootstrap pseudo-replication of the ``normal'' matrix with the ``randomised'' one being a random one and the ``maximised'' and ``minimised'' being conditional bootstraps.
This step resulted in a total of 1440 matrices (hereafter called the ``normal'', ``maximised'', ``minimised'' and ``randomised'' matrices - see Fig. \ref{Fig:modif_matrix} for an illustration).
The algorithms for the three modifications are available on GitHub (\url{https://github.com/TGuillerme/CharactersCorrelation})

\begin{figure}[!htbp]
\centering
   \includegraphics[width=1\textwidth]{Figures/Modif_matrix.pdf}
\caption{Example illustration of the protocol for modifying matrices. The matrices represent the pairwise character differences for 100 characters. Blue colours correspond to low character differences and orange colours correspond to high character differences. \textbf{A} - a random Birth-Death tree is simulated and used for generating the ``normal'' matrix (\textbf{B}), characters in this matrix are then removed or duplicated to favour maximised character difference (\textbf{C}), minimised it (\textbf{D}) or randomise it (\textbf{E}).}
\label{Fig:modif_matrix}
\end{figure}

\subsection{Inferring topologies}
We inferred the topologies in both Bayesian and Maximum Parsimony using MrBayes \citep[v3.2.6;][]{Ronquist2012mrbayes} and PAUP* \citep[v4.0a151;][]{swofford2001paup} respectively.
For both methods, we used the arbitrarily chosen outgroup in the simulations to root our trees.
The Maximum Parsimony inference was run using a heuristic search with random sequence addition replicate 100 times with a limit of $5\times10^6$ rearrangements per replicates (\texttt{hsearch addseq=random nreps=100 rearrlimit=5000000 limitperrep=yes}).

The Bayesian inference was run using an M\textit{k} model with ascertainment bias and four discrete gamma rate categories (M\textit{kv} $4\Gamma$ - \texttt{lset nst=1 rates=gamma Ngammacat=4}) with an variable rate prior an exponential (0.5) shape (\texttt{prset ratepr=variable Shapepr=Exponential(0.5)}).
We ran two runs of 6 chains each (2 hot, 4 cold) for a maximum of $1\times10^9$ generations with a sampling every 200 generations.
We automatically stopped the MCMC when the average standard deviation of split frequencies (ASDSF) between both runs fell below 0.01 (with a diagnosis every $1\times10^4$ generations - \texttt{mcmc nruns=2 Nchains=6 ngen=1000000000 samplefreq=200 printfreq=2000 diagnfreq=10000 Stoprule=YES stopval=0.01 mcmcdiagn=YES}).
Due to cluster hardware requirements an to save some time, when chains didn't converged and the runs exceeded 5GB each, we aborted the MCMC and computed the consensus tree from the unconverged chains.
In practice, these few MCMC got stuck at an ASDSF around (but not below) 0.01.

A strict majority rule tree was then calculated for both Bayesian an Maximum Parsimony trees.
For the Bayesian consensus trees, the 25\% first trees of the posterior tree distribution were excluded as a burnin.
The 2880 tree inferences took around one CPU century on the Imperial College High Performance Computing Service \citep[2-3GHz clock rate;][]{HPC}.

\subsection{Comparing topologies}
We compared the topologies using the same approach as in \cite{Guillerme2016146}: we measured both the Robinson-Fould distance \citep{RF1981} and the Triplets distance \citep{dobson1975triplets} between the trees inferred from the ``maximised'', ``minimised'' and ``randomised'' matrices and the tree inferred from the ``normal'' matrix.
We explored the effect of character difference on recovering the ``normal'' topology by comparing the ``maximised'', ``minimised'' and ``randomised'' trees to the ``normal'' tree (Figs \ref{Fig:RF_results_best} and \ref{Fig:Tr_results_best} and Supplementary materials 3).

The metrics scores where calculated using the \texttt{TreeCmp} javascript \citep{Bogdanowicz2012}.
The measurements where then standardised using the Normalised Tree Similarity metric \citep[$NTS$; i.e. centering the metrics scores using the mean metric score for 1000 pairwise comparisons between random trees with $n$ taxa;][]{Bogdanowicz2012,Guillerme2016146}.
When the normalised metric has a score of one it means both trees are identical, when it has a score of zero it means the trees are no more different than expected by chance and when it has a score $<0$ the trees are more different than expected by chance.
The normalised score for both metrics thus reflects two distinct aspects of tree topology: (1) the Normalised Robinson-Fould ($NTS_{RF}$) Similarity reflects the conservation of clades (i.e. a score close to $1$ indicates that most clades are identical in both trees); and (2) the Normalised Triplets Similarity ($NTS_{Tr}$) reflects the position of taxa (i.e. a score close to $1$ indicates that most taxa have the same neighbours in both trees).

Because both $NTS_{RF}$ and $NTS_{Tr}$ metrics are bounded at one, the resulting in the residuals of any model based on the $NTS$ scores were not normal thus preventing the use of parametric tests for comparisons (see Supplementary material 3).
Similarly, a non-parametric Wilcoxon rank test \citep{hollander2013nonparametric} would be biased in their p-value calculation due to the presence of equal values in the $NTS$ distributions (e.g. when multiple trees are equal to the ``normal'' tree).
Therefore, we used a combination of the Wilcoxon rank test with a Bonferonni-Holm corrections \citep[to ensure our significant results were robust to Type I error rate inflation;][]{holm1979simple} and a simple non-parametric metric for measuring the probability of overlap between two distributions, the Bhattacharyya Coefficient \citep[$BC$;][]{Bhattacharyya,Guillerme2016146,soto2016trace}.
Thus, additionally to the Wilcoxon test results, we considered distribution to be significantly similar if they had an overlap probability $>0.95$ and different if they had an overlap probability $>0.05$.
Comparisons falling between these range can not be designated as strictly similar/different but can still be ranked (e.g. for three distributions A, B, C, if $BC_{(A,B)} = 0.15$ and $BC_{(A,C)} = 0.65$, we cannot consider either distribution significantly different or similar but $B$ still has a lower probability of being similar to $A$ than $C$).

\section{Results}

\begin{figure}[!htbp]
\centering
   \includegraphics[width=1\textwidth]{Figures/RF_results_best.pdf}
\caption{\small{Effect of character difference on recovering the ``normal'' topology. The y axis represents the Normalised Tree Similarity using Robinson-Fould distance for matrices with 25, 75 and 150 taxa from top to bottom respectively. The x axis represents the different character difference scenarios and tree inference method with the ``maximised'' character difference in Bayesian (red) and under Maximum Parsimony (orange), the ``minimised'' character difference in Bayesian (dark green) and under Maximum Parsimony (light green) and the ``randomised'' character difference in Bayesian (dark blue) and under Maximum Parsimony (light blue) for matrices of 100, 350 and 1000 characters in the panels from left to right.}}
\label{Fig:RF_results_best}
\end{figure}

\begin{figure}[!htbp]
\centering
   \includegraphics[width=1\textwidth]{Figures/Tr_results_best.pdf} %TG: These figures will be cleaned up once I have the final results.
\caption{Effect of character difference on recovering the ``normal'' topology. The axis are identical to figure \ref{Fig:RF_results_best} but y axis represents the Normalised Tree Similarity using Triplets distance.}
\label{Fig:Tr_results_best}
\end{figure}

\subsection{Effect of character differences on topology}

The overall amount of character difference in a matrix has an effect of the ability to recover the correct topology with maximising the character difference leading to the smallest loss in phylogenetic information (median $NTS_{RF}$ = 0.95 and median $NTS_{Tr}$ = 0.96) followed by simply randomising the characters (median $NTS_{RF}$ = 0.79 and median $NTS_{Tr}$ = 0.72) and minimising the character difference (median $NTS_{RF}$ = 0.6 and median $NTS_{Tr}$ = 0.28 - see Supplementary material 3 for the full summary statistics).
There is a significant difference between all scenarios (maximising, minimising and randomising) with the highest probability of overlap being between maximising and randomising the character difference (Bhattacharrya Coefficient of 0.89 for the $NTS_{RF}$ and 0.92 for the $NTS_{Tr}$ - Table \ref{Tab_pooledscenarios_test}) and the lowest probability between maximising and minimising the character difference (Bhattacharrya coefficient of 0.59 for the $NTS_{RF}$ and 0.63 for the $NTS_{Tr}$ - Table \ref{Tab_pooledscenarios_test})

\begin{table}[ht]
\centering
\begin{tabular}{ll|r|rr}
  \hline
metric & test & bhatt.coeff & statistic & p.value \\ 
  \hline
RF & maxi:mini & 0.588 & 439466.500 & \textbf{0.000} \\ 
   & maxi:rand & 0.894 & 347624.500 & \textbf{0.000} \\ 
   & mini:rand & 0.846 & 115008.500 & \textbf{0.000} \\ 
Tr & maxi:mini & 0.628 & 443049.500 & \textbf{0.000} \\ 
   & maxi:rand & 0.921 & 348074.000 & \textbf{0.000} \\ 
   & mini:rand & 0.825 & 113171.500 & \textbf{0.000} \\ 
   \hline
\end{tabular}
\caption{Difference between the pooled scenarios. bhatt.coeff is the Bhattacharrya Coefficient (probability of overlap), the statistic and the p.value are from a non-parametric Wilcoxon test (with Bonferonni-Holm correction), significant values are in bold.} 
\label{Tab_pooledscenarios_test}
\end{table}

\subsubsection{Effect of the number of characters}

This effect of the character difference is not dependent on the number of characters for the clade conservation (i.e. $NTS_{RF}$) for a ``similar'' number of characters (median $NTS_{RF}$ for 100, 350 and 1000 characters equals 0.76, 0.78, 0.8 respectively - see supplementary materials 3) with a significant effect only between 100 and 1000 characters (Table \ref{Tab_pooledscharacters_test}).
The number of characters affects the character difference more in terms of taxa placement for a low number of characters (median $NTS_{RF}$ for 100, 350 and 1000 characters equals 0.54, 0.70, 0.76 respectively - see supplementary materials 3) with a significant difference between 100 and 350 or 1000 characters (Table \ref{Tab_pooledscharacters_test}).
These difference have to be contrasted however by a really high probability of overlap between each number of characters and metrics (Bhattacharrya Coefficient always $>0.95$) suggesting that the significant effects of the number of characters still leads to really similar distributions.

\begin{table}[ht]
\centering
\begin{tabular}{ll|r|rr}
  \hline
metric & test & bhatt.coeff & statistic & p.value \\ 
  \hline
RF & c100:c350 & \textbf{0.989} & 228495.000 & 0.174 \\ 
   & c100:c1000 & \textbf{0.983} & 218305.500 & \textbf{0.002} \\ 
   & c350:c1000 & \textbf{0.988} & 232832.500 & 0.643 \\ 
  Tr & c100:c350 & \textbf{0.965} & 203355.500 & \textbf{0.000} \\ 
   & c100:c1000 & \textbf{0.959} & 189064.000 & \textbf{0.000} \\ 
   & c350:c1000 & \textbf{0.983} & 226472.000 & 0.085 \\ 
   \hline
\end{tabular}
\caption{Difference between the pooled number of characters. See Table \ref{Tab_pooledscenarios_test} for full caption.} 
\label{Tab_pooledscharacters_test}
\end{table}

\subsubsection{Effect of the number of taxa}

Similarly than the effect of number of characters on character difference, the number of taxa seems to have only a marginal effect.
A low number of taxa (25) resulted in significant differences in both $NTS_{RF}$ and $NTS_{Tr}$ (medians for 25, 75 and 150 taxa equals 0.8, 0.76, 0.75 $NTS_{RF}$ and 0.75, 0.59 and 0.59 $NTS_{Tr}$respectively - Table \ref{Tab_pooledstaxa_test} and see supplementary materials 3).
Again, however, the significant differences have to be contrasted with still high probabilities of overlaps for each $NTS_{RF}$ and $NTS_{Tr}$ distributions for every number of taxa (Table \ref{Tab_pooledstaxa_test}).

\begin{table}[ht]
\centering
\begin{tabular}{ll|r|rr}
  \hline
metric & test & bhatt.coeff & statistic & p.value \\ 
  \hline
RF & t25:t75 & \textbf{0.987} & 267274.500 & \textbf{0.003} \\ 
   & t25:t150 &\textbf{0.979} & 272359.500 & \textbf{0.000} \\ 
   & t75:t150 & \textbf{0.988} & 247619.500 & 1.000 \\ 
Tr & t25:t75 & \textbf{0.975} & 282017.500 & \textbf{0.000} \\ 
   & t25:t150 & \textbf{0.970} & 279730.000 & \textbf{0.000} \\ 
   & t75:t150 & \textbf{0.989} & 240414.500 & 1.000 \\ 
   \hline
\end{tabular}
\caption{Difference between the pooled number of taxa. See Table \ref{Tab_pooledscenarios_test} for full caption.} 
\label{Tab_pooledstaxa_test}
\end{table}

\subsection{Effect of character differences on the inference method}

Regarding the inference method, there is a significant difference in clade conservation between Bayesian and Maximum Parsimony (Table \ref{Tab_pooledsmethods_test} - median $NTS_{RF}$ of 0.82 and 0.68 respectively) but not in terms of individual taxa placements (Table \ref{Tab_pooledsmethods_test} - median $NTS_{Tr}$ of 0.72 and 0.61 respectively).

\begin{table}[ht]
\centering
\begin{tabular}{llrrr}
  \hline
metric & test & bhatt.coeff & statistic & p.value \\ 
  \hline
RF & bayesian:parsimony & 0.893 & 676940.500 & \textbf{0.000} \\ 
Tr & bayesian:parsimony & \textbf{0.982} & 547140.000 & 0.147 \\ 
   \hline
\end{tabular}
\caption{Difference between the pooled methods. See Table \ref{Tab_pooledscenarios_test} for full caption.} 
\label{Tab_pooledsmethods_test}
\end{table}

\subsection{Combined effects}

When looking at the combined effect of each parameters, the ``maximised'' and ``minimised'' scenarios are always significantly different with no high probability of overlap for both $NTS_{RF}$ and $NTS_{Tr}$ (Wilcoxon rank test p.value $<0.05$ and Bhattacharrya Coefficient $<0.95$ - see supplementary material 3).
The same differences are observed when comparing the ``maximised'' scenario against the ``randomised'' one expect for: (1) the Bayesian inference with 25 taxa (with 100, 350 and 1000 characters) and with 75 taxa with 1000 characters for both $NTS_{RF}$ and $NTS_{Tr}$; and (2) the Maximum Parsimony for 25 taxa (with 350 and 1000) characters for both $NTS_{RF}$ and $NTS_{Tr}$ and 75 taxa with 100 characters for $NTS_{Tr}$.
Identically, there was always a significant difference between the ``minimised'' scenario and the ``randomised'' one was expect for the matrix of 150 taxa and 100 characters under Maximum Parsimony for $NTS_{RF}$ and the matrix of 150 and 1000 characters under Bayesian inference for $NTS_{Tr}$.
The full list of comparisons and summary statistics are available in the supplementary materials 3.

\section{Discussion}

\subsection{Effect of character differences on topology}
As expected, there is an significant effect of the characters difference in the ability to recover the correct topology.
The character difference metric can be seen as the inverse of character correlation (see Methods \ref{CD_description}): a high character difference approximates a low level of character correlation and vice versa.
When characters are correlated, one could expect the matrices to convey a really strong (but potentially misleading) phylogenetic signal since every characters agrees with each other and conversely, when characters are uncorrelated, one could expect them to convey a weaker phylogenetic signal with a high amount of homoplasies.
Intuitively, this would lead to the ``minimised'' character difference scenario to lead to incorrect but consistent trees, the ``maximised'' scenario to lead to poorly resolved once (really homoplasic trees) and the ``randomised'' scenario to perform the best at recovering the correct topology.
Although the expected results appear to be true for a low character difference scenario, increasing the character difference surprisingly improves the ability to recover the ``normal'' topology both in terms of clade conservation ($NTS_{RF}$) and taxa placement ($NTS_{Tr}$) for both inference methods (especially in bigger matrices; Figs \ref{Fig:RF_results_best} and \ref{Fig:Tr_results_best}).

Following these results, we encourage researchers to code characters that appear to be the most un-correlated \textit{a priori}.
However, it is noteworthy to point that in rather small matrices, there was no significant difference in terms of recovering the right topology when maximising or randomising the character differences.
Since many matrices are in this size range \citep{guillerme2016assessment} a simple bootstrap analysis (i.e. as an equivalent of randomising the character differences) can be sufficient to obtain good results (\textit{cf.} actively collecting different characters).

\subsubsection{Effect of the number of characters and taxa}
Because of the nature of our simulation protocol, one could expect that the effect of character correlation would have increased with the number of characters (i.e. the more characters available, the more characters are modified in each scenario).
Similarly, one could expect the number of taxa to have an effect of the raw ability to recover the ``normal'' topology (i.e. the more taxa, the more likely taxa are misplaced by chance.)

Although we measured a significant difference between ``small'' a larger matrices (both in terms of number of taxa and characters; Tables \ref{Tab_pooledscharacters_test} and \ref{Tab_pooledstaxa_test}), these differences have to be contrasted with the probability of overlap between the results distribution that is always really high between every matrices sizes (Bhattacharrya Coefficients $>0.965$ for both the different number of characters and taxa).
This suggest that the effect of character correlation on recovering the right topology is independent of the size of the matrix when pooling the data.
For the number of characters, this suggests that the overall character difference metric is a good proxy for character correlation and is independent of the number of characters analysed.
Similarly, using the a Normalised Tree Similarity metric ($NTS$) allows to account for the fact that topological difference is affected by the sheer number of taxa considered (i.e. we here corrected for the expected difference when comparing two random trees with the same number of taxa).

\subsection{Effect of character differences on the inference method}
When considering the pooled effect of the tree inference method, we only detected a significant difference between the Bayesian and the Maximum Parsimony trees in terms of clade conservation but none in terms of taxa placement (both using a Wilcoxon test and the Bhattacharrya Coefficient; Table \ref{Tab_pooledsmethods_test}).
The difference in the ability of both methods in recovering the ``right'' topology has been heavily discussed in the last five years with some indications that Bayesian inference will more readily recover the ``right'' topology when analysing discrete morphological characters alone (\citealt{wrightbayesian2014,OReilly20160081,puttick2017uncertain}; although some critics have been made in favour of parsimony: \citealt{spencerefficacy2013,goloboff2017weighted}).
In this study, it is possible that our simulation protocol for generating the characters (favouring slightly more M$k$-based characters rather than HKY ones) could slightly favour Bayesian inference over Parsimony, however, our protocol for selecting matrices \citep[i.e. those with in a $CI>0.26$ in a quick preliminary parsimony search;][]{OReilly20160081} could also favour Parsimony analysis.
It was however not the purpose of this study to compare the overall performance of both methods but rather to measure the effect of character correlation on each of those methods separately.

This being said, it is interesting to analysis this difference in tree inference method in the light of the effect of high/low character differences.
In fact the differences observed here could be due to the inherent mechanisms of each method.
When many characters are homoplasic (high character difference) parsimony will cope with this information by generating longer trees (which will be more likely to be discarded in the tree search).
Conversely, Bayesian analysis can (1) cope with homoplasy more easily by increasing branch length to accommodate more changes and (2) will also incorporate sub-optimal trees in the final results.
These two points could explain the fact that the effect of character correlation seems less important in Bayesian inference, especially in terms of clade conservation.

\subsection{Distinction between different character correlations}
The two types of correlations that most evolutionary biologists are genuinely interested in (biological and evolutionary) can only be studied \textit{a posteriori} using phylogenetic trees and should not be used as an \textit{a priori} criterion to validate/invalidate characters.
The links between specific characters should be studied explicitly through hypothesis testing based on an underlying phylogenetic framework - for example in evo-devo \citep[e.g.][]{goswami2006morphological} or in macroevolution \citep[e.g.][]{fitzjohn2014much} - and should thus be independent of the phylogenetic inference itself.
In practice, therefore, only the correlation induced by data collection (i.e. coding correlation) can really affect the phylogeny \textit{a priori}.

This dichotomy thus creates a trade of between: (1) coding fewer characters (stochastically reducing \textit{a priori} correlation) but making the \textit{a posteriori} correlation more dependent on the coding; and (2) coding more characters (increasing \textit{a priori} dependence) but allowing the \textit{a posteriori} correlation being less dependent on the coding correlations.

Effectively, this study focuses on the effect of coding induced correlation since our scenarios to maximise/minimise character difference are equivalent to actively choosing characters that are the most different/similar \textit{prior} to any phylogenetic analysis.
The evolutionary correlation is also present in this simulations since the characters are modelled on Birth-Death trees.
Similarly, biological induced correlation (i.e. modularity) can be present in the matrices for those characters randomly simulated with similar evolutionary simulation regimes.
However, the effect of these sources of correlation was out of the scope of this study and would have required \textit{a posteriori} changes to the matrices which are - when using empirical data - at best bad practice and at worth dishonest.

\subsection{Conclusion}
Correlation between characters can be induced through three main phenomenon: biological features, evolutionary history or biases in coding the characters.
Although one could argue (righteously!) that coding induced correlation is easily avoidable and that biological and evolutionary correlations are actually at the core of evolutionary biology, in the age of ever expanding morphological matrices \citep[e.g.][with more than 1000 characters each]{nithe2013,O'Leary08022013}, we can expect the dependence between characters to increase stochastically.
Moreover, because phylogenetic inference software are unable to \textit{a priori} differentiate these difference correlations, it is important to understand to what extant topologies can be induced by such bias.

We found that character differences as a proxy for character correlation have a strong effect on the recovering the ``normal'' topology: when character correlation was high (low character differences), the topology was always the furthest away from the ``normal'' topology.
Conversely, when correlation between characters was low, the topology was always the closest to the ``normal'' topology.
These results seems independent on the size of the matrix (number of taxa and/or characters) but can be influenced by the phylogenetic inference method used with Bayesian inference faring better in terms of clade conservation, especially in larger matrices.

However, in modest size matrices (25 taxa 100 to 350 characters), the effect of actively choosing to minimise character correlation was not more significant than simply bootstrapping the matrix, suggesting that character correlation is more a problem in large discrete morphological matrices.
We hope that these results will encourage researchers working on discrete morphological characters to continue exploring morphology through discrete characters to better understand the Tree of Life.

\section{Data availability, repeatability and reproducibility}
The consensus trees are available on figshare at \url{@@@}.
The simulations are fully replicable following the explanations at \url{https://github.com/TGuillerme/CharactersCorrelation}.
The post-simulation analysis, tables and figures (reported in this manuscript) are fully reproducible see (\url{https://github.com/TGuillerme/CharactersCorrelation}).

\section{Funding}
European Research Council under the European Union’s Seventh Framework Programme (FP/2007–2013)/ERC Grant Agreement number 311092.

\section{Acknowledgements}
Calculations where done using the Imperial College London Cluster Services (doi: 10.14469/hpc/2232).
We thank Alberto Pascual Garcia for input in the design of the simulations protocol and Guillermo Herraiz Yebes for helping with the CD metric proof.


% Suggested reviewers:
%- Liliana Davalos for MPE / Joe O'Reilly, April Wright 


\bibliographystyle{sysbio}
\bibliography{References}

\end{document}

